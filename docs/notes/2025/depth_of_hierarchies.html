<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-11-03">
<meta name="description" content="Context for Luck, skill, and depth of competition in games and social hierarchies">

<title>Depth of hierarchies – Max Jerdee</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/images/icon.svg" rel="icon" type="image/svg+xml">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-707d8167ce6003fca903bfe2be84ab7f.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-f93c2b1f3f0577f377aefa4848a86a36.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-0d4a9d19931feb4fee1ddab4b2489000.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-f93c2b1f3f0577f377aefa4848a86a36.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SY1YC6MMLM"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SY1YC6MMLM', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Max Jerdee</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../research.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../papers.html"> 
<span class="menu-text">Papers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code.html"> 
<span class="menu-text">Code</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../demos.html"> 
<span class="menu-text">Demos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../notes.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../assets/pdf/CV.pdf"> 
<span class="menu-text">CV</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#motivation" id="toc-motivation" class="nav-link active" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#minimum-violation-ranking" id="toc-minimum-violation-ranking" class="nav-link" data-scroll-target="#minimum-violation-ranking">Minimum Violation Ranking</a></li>
  <li><a href="#the-bradley-terry-model" id="toc-the-bradley-terry-model" class="nav-link" data-scroll-target="#the-bradley-terry-model">The Bradley-Terry model</a></li>
  <li><a href="#depth-and-bayesian-inference" id="toc-depth-and-bayesian-inference" class="nav-link" data-scroll-target="#depth-and-bayesian-inference">Depth and Bayesian inference</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Depth of hierarchies</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Inference</div>
    <div class="quarto-category">Paper Explainer</div>
  </div>
  </div>

<div>
  <div class="description">
    Context for <em>Luck, skill, and depth of competition in games and social hierarchies</em>
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 3, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>This post gives some context for a <a href="https://www.science.org/doi/10.1126/sciadv.adn2654">paper</a> written in collaboration with Mark Newman. The presentation here is adapted from my <a href="../2025/thesis.html">PhD thesis</a>.</p>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>When players enter a sports tournament, students attend a high school, or chickens are placed in a coop, hierarchies tend to emerge (along with those who study them). This pecking order can be reflected in chess game victories, unreciprocated friendships, or chicken pecks. Across these <a href="../2025/network_structures.html#hierarchy-structure">examples</a>, we would like to infer the rankings of the participants and predict the outcomes of unobserved matches. In this work we introduce a model that allows us to not only find positions within such a hierarchy but also to measure how strict, how unequal that hierarchy is. Across the contexts we consider we find sports are relatively egalitarian as matches could typically go either way, while animal hierarchies follow a much stricter, predictable order. The examples of human social hierarchies we consider, from patterns of friendship to faculty hiring, tend to fall between these extremes.</p>
</section>
<section id="minimum-violation-ranking" class="level2">
<h2 class="anchored" data-anchor-id="minimum-violation-ranking">Minimum Violation Ranking</h2>
<p>Before describing our full model, we begin with a simpler definition of hierarchies. Many observers of these systems, especially in sports, may come to their own, often quite different conclusions about the appropriate ranking of the competitors. Out of these possibilities, it is useful to have a consistent benchmark for what constitutes a "good" or "fair" ranking given the results.</p>
<p>A natural starting point is to ask that a ranking is consistent with the observations in the following sense: the favorite, the higher ranked player, should typically win the match. To analyze a ranking in this way, we first specify it as vector&nbsp;<span class="math inline">\(\boldsymbol{s}\)</span> where player&nbsp;<span class="math inline">\(i\)</span> is assigned score&nbsp;<span class="math inline">\(s_i\)</span>, and player&nbsp;<span class="math inline">\(i\)</span> is considered better than player&nbsp;<span class="math inline">\(j\)</span> in the ranking if they have a higher score,&nbsp;<span class="math inline">\(s_i &gt; s_j\)</span>. In this notation, we can then count up the number of times that the favorite indeed wins as</p>
<div style="overflow-x:auto;overflow-y:hidden;">
<p><span class="math display">\[\begin{align}
    m_{\text{win}}(\boldsymbol{A},\boldsymbol{s}) = \sum_{ij} A_{ij} \mathbf{1} \{s_i &gt; s_j\}
\end{align}\]</span></p>
</div>
<p>where the adjacency matrix entry&nbsp;<span class="math inline">\(A_{ij}\)</span> counts the number of times player <span class="math inline">\(i\)</span> beats player <span class="math inline">\(j\)</span>.</p>
<p>In lieu of a known rating of the participants, we can then define a ranking by maximizing the number of times the favorite indeed wins as</p>
<div style="overflow-x:auto;overflow-y:hidden;">
<p><span class="math display">\[\begin{align}
    \boldsymbol{s}* = \text{argmax}_{\boldsymbol{s}} m_{\text{win}}(\boldsymbol{A},\boldsymbol{s}).
\end{align}\]</span></p>
</div>
<p>This strategy is known as <em>minimum violation ranking</em> since it is equivalent to minimizing the number of upset wins, or "violations" of the ranking.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> It is computationally demanding to find the true optimal ranking in this sense, and heuristic algorithms are often employed&nbsp;<span class="citation" data-cites="CCP23">(<a href="#ref-CCP23" role="doc-biblioref">Cavallaro, Cutello, and Pavone 2023</a>)</span>. In <a href="#fig-MVR" class="quarto-xref">Figure&nbsp;1</a>a we use this method to rank the football teams within the 2022 season Big Ten conference <span class="citation" data-cites="Football22">(<a href="#ref-Football22" role="doc-biblioref"><span>“College Football Records,”</span> n.d.</a>)</span> based upon the wins and losses amongst them. Although no perfectly consistent ranking is possible, when we vertically arrange the 14 teams according to the minimum violation ranking <span class="math inline">\(m_{\text{win}} = 57\)</span> of the&nbsp;<span class="math inline">\(m = 64\)</span> total matches are won by the favored team (highlighted in green).</p>
<div id="fig-MVR" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MVR-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../assets/images/notes/depth_of_hierarchies/MVR.svg" class="img-fluid figure-img" style="width:8.74485in">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MVR-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: College football matches played in the 2022 Big Ten conference football season. (a) Arrows represent that one team beat another, teams are vertically arranged to minimize the number of upset victories (in red). (b) Arrows indicate that one team hosts another. Teams are vertically positioned to minimize ranking violations. (c) The number of times the favorite "wins" in each context, beating or hosting, are compared against 10,000 simulations where outcomes are sampled as fair coin flips.
</figcaption>
</figure>
</div>
<p>We can also use the number of favorite wins&nbsp;<span class="math inline">\(m_{\text{win}}\)</span> as a test statistic to establish the presence of a hierarchy in a <a href="../2025/statistical_inference.html#a-fair-coin">significance test</a>. As a null hypothesis, we use a "fair coin" model that either team is equally likely to prevail in any given match regardless of their ranking, each outcome might as well be a flip of a coin. In this null model, the favorite team wins half the time for an average of&nbsp;<span class="math inline">\(m_{\text{win}} = 32\)</span>. However due to random fluctuations the favorites may happen to accumulate more wins than expected.</p>
<p>In <a href="#fig-MVR" class="quarto-xref">Figure&nbsp;1</a>c we perform 10,000 simulations of the null model, of flipping a coin to decide each match, and find that not once did the favorite win more than&nbsp;<span class="math inline">\(m_{\text{win}} = 47\)</span> matches. Since this is far from the number~<span class="math inline">\(m_{\text{win}} = 57\)</span> we observe in the football hierarchy, we can reject the fair coin model and conclude that genuine gaps in skill are driving the match outcomes.</p>
<p>In <a href="#fig-MVR" class="quarto-xref">Figure&nbsp;1</a>b we plot another network of the very same matches within the conference, but now where a "win" indicates that one team hosted the other rather than beat them. Intuitively we might expect this interaction to not be strongly driven by a hierarchy among the teams, but rather be more akin to the coin flip model. Yet, if again identify the minimum violations ranking, we can construct an ordering of the teams where the favorite wins&nbsp;<span class="math inline">\(m_{\text{win}} = 45\)</span> times. Returning to the significance testing, in only 8 of the 10,000 simulations did random flips generate more favorite wins than this mark for a p-value <span class="math inline">\(P &lt; 0.001\)</span>. In isolation this would be seen as very strong evidence of our found hierarchy, although since this ranking is chosen among&nbsp;<span class="math inline">\(14! = 87178291200\)</span> possible orderings, the low p-value may not be as impressive as it first appears.</p>
</section>
<section id="the-bradley-terry-model" class="level2">
<h2 class="anchored" data-anchor-id="the-bradley-terry-model">The Bradley-Terry model</h2>
<p>In order to establish that a hierarchy is present in a more intrinsic manner, and to make predictions (e.g.&nbsp;who will win the next game?) we turn to generative models that assign a probability to each potential outcome of the matches. Particularly, we consider the Bradley-Terry model, named after the work of R. Bradley and M. Terry who described it in 1952&nbsp;<span class="citation" data-cites="BT52">(<a href="#ref-BT52" role="doc-biblioref">Bradley and Terry 1952</a>)</span>, although it was (unknown to them) first introduced much earlier, by Zermelo in 1929&nbsp;<span class="citation" data-cites="Zermelo29">(<a href="#ref-Zermelo29" role="doc-biblioref">Zermelo 1929</a>)</span>. In the model, the probability&nbsp;<span class="math inline">\(p_{ij}\)</span> that node&nbsp;<span class="math inline">\(i\)</span> beats node&nbsp;<span class="math inline">\(j\)</span> is assumed to depend upon the difference&nbsp;<span class="math inline">\(s_i - s_j\)</span> between their scores. Specifically, the win probability is taken to be a logistic sigmoid function of this difference as</p>
<div style="overflow-x:auto;overflow-y:hidden;">
<p><span id="eq-BT-win-probability"><span class="math display">\[\begin{align}
    p_{ij} = \frac{1}{1 + e^{-(s_i - s_j)}}.
\end{align} \tag{1}\]</span></span></p>
</div>
<div id="fig-BT-curve" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-BT-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../assets/images/notes/depth_of_hierarchies/BT-curve.svg" class="img-fluid figure-img" style="width:8.30098in">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-BT-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Win probability&nbsp;<span class="math inline">\(p_{ij}\)</span> as a function of score difference&nbsp;<span class="math inline">\(s_i - s_j\)</span> in the Bradley-Terry model as in <a href="#eq-BT-win-probability" class="quarto-xref">Eq.&nbsp;1</a>.
</figcaption>
</figure>
</div>
<p>This function, plotted in <a href="#fig-BT-curve" class="quarto-xref">Figure&nbsp;2</a>, has a number of intuitive properties. If the two participants are evenly matched,&nbsp;<span class="math inline">\(s_i = s_j\)</span>,&nbsp;<span class="math inline">\(p_{ij} = 1/2\)</span> and each competitor is equally likely to prevail. If node&nbsp;<span class="math inline">\(i\)</span> is considerably better than node&nbsp;<span class="math inline">\(j\)</span>,&nbsp;<span class="math inline">\(s_i \gg s_j\)</span>, they are very likely to win as&nbsp;<span class="math inline">\(p_{ij} \rightarrow 1\)</span>. Conversely if they are thoroughly outmatched and&nbsp;<span class="math inline">\(s_i \ll s_j\)</span>, node&nbsp;<span class="math inline">\(i\)</span> is unlikely to win as&nbsp;<span class="math inline">\(p_{ij} \rightarrow 0\)</span>. This <em>score function</em> also critically assigns a behavioral meaning to a particular score differential. If node&nbsp;<span class="math inline">\(i\)</span> is one "unit" above node&nbsp;<span class="math inline">\(j\)</span> in the hierarchy, they will win with probability</p>
<div style="overflow-x:auto;overflow-y:hidden;">
<p><span class="math display">\[\begin{align}
    p_{ij} = \frac{1}{1 + e^{-1}} \approx 0.731.
\end{align}\]</span></p>
</div>
<p>This gap then defines the meaning of a "tier" or "level" of skill differential, a difference that leads the favorite to win roughly 70-75% of the time.</p>
<p>Compiling these win probabilities across all of the matches then yields the Bradley-Terry model likelihood</p>
<div style="overflow-x:auto;overflow-y:hidden;">
<p><span class="math display">\[\begin{align}
    P(\boldsymbol{A}|\boldsymbol{s}) = \prod_{ij} p_{ij}^{A_{ij}} = \prod_{ij} \left(\frac{1}{1 + e^{-(s_i - s_j)}}\right)^{A_{ij}}.
\end{align}\]</span></p>
</div>
<p>In most treatments of the Bradley-Terry model, we then find the values of the scores that maximize this likelihood of generating the data that we observe. These <em>maximum-likelihood</em> values, however, are generally prone to <a href="../2025/statistical_inference.html#a-biased-coin">overfitting</a>. If a given team (such as the University of Michigan) finishes undefeated, the model assigns them an infinite maximum-likelihood score, effectively suggesting they always had a 100% chance of winning against any opponent, past or future — an extrapolation that could make even the most ardent fan blush.</p>
</section>
<section id="depth-and-bayesian-inference" class="level2">
<h2 class="anchored" data-anchor-id="depth-and-bayesian-inference">Depth and Bayesian inference</h2>
<p>To address this is issue we consider a Bayesian treatment of the Bradley-Terry model. This perspective naturally allows us to not only quantify the uncertainty in our inferences but also measure the nature of these hierarchies. For this we introduce a <em>prior distribution</em> that reflects our expectation about the overall distribution of strengths within the hierarchy. Particularly, on each score&nbsp;<span class="math inline">\(s_i\)</span> we introduce an independent Gaussian prior of width&nbsp;<span class="math inline">\(\beta/\sqrt{2}\)</span> for parameter&nbsp;<span class="math inline">\(\beta &gt; 0\)</span>,</p>
<div style="overflow-x:auto;overflow-y:hidden;">
<p><span class="math display">\[\begin{align}
    P(\boldsymbol{s}|\beta) = \prod_{i=1}^n \frac{1}{\beta\sqrt{\pi}} e^{-s^2/\beta^2}. \label{eq:P-s-given-beta}
\end{align}\]</span></p>
</div>
<p>This choice is made so that the distribution of the <em>differences</em> in scores&nbsp;<span class="math inline">\(s_i - s_j\)</span> follow a Gaussian distribution of width&nbsp;<span class="math inline">\(\beta\)</span>. The&nbsp;<span class="math inline">\(\beta\)</span> parameter therefore controls the typical difference in score between two random players. Given the meaning of one unit of score difference, <span class="math inline">\(\beta\)</span> counts how many layers of skill or status are present in the hierarchy between the typical pair. With this interpretation, we define this parameter in our work as the <em>depth of competition</em>&nbsp;<span class="citation" data-cites="JN24">(<a href="#ref-JN24" role="doc-biblioref">Jerdee and Newman 2024</a>)</span>.</p>
<div id="fig-BT-generation" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-BT-generation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../assets/images/notes/depth_of_hierarchies/BT-generation.svg" class="img-fluid figure-img" style="width:8.85584in">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-BT-generation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Example generative process for the Bradley-Terry model of hierarchies. (a) The depth&nbsp;<span class="math inline">\(\beta\)</span> is first fixed, then the scores&nbsp;<span class="math inline">\(\boldsymbol{s}\)</span> are sampled from a Gaussian of that width, represented by the vertical distribution with width&nbsp;<span class="math inline">\(\beta = 3\)</span>. The differences of these scores then inform who wins each match, where the higher score participant is favored. (b) This same process starting with a depth of&nbsp;<span class="math inline">\(\beta = 1\)</span>. This smaller depth leads to smaller differences in scores and so more upset wins, colored in red.
</figcaption>
</figure>
</div>
<p>Starting with a half-Cauchy prior <span class="math inline">\(P(\beta)\)</span> over the depth, <a href="#fig-BT-generation" class="quarto-xref">Figure&nbsp;3</a> demonstrates the full generative process in the Bradley-Terry model.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> <a href="#fig-BT-generation" class="quarto-xref">Figure&nbsp;3</a>a shows an example where the depth&nbsp;<span class="math inline">\(\beta = 3\)</span> is relatively high. Since the typical difference between scores is large, most matches are won by the favorite. In contrast, <a href="#fig-BT-generation" class="quarto-xref">Figure&nbsp;3</a>b illustrates a lower depth of&nbsp;<span class="math inline">\(\beta = 1\)</span> where the now smaller score differences lead to more upsets – violations of the ranking. From this perspective we also notice that if the depth is&nbsp;<span class="math inline">\(\beta = 0\)</span> all of the scores must be the same and so all matches are even, recovering the fair coin null model considered earlier.</p>
<p>Given a network&nbsp;<span class="math inline">\(\boldsymbol{A}\)</span> we can then take Markov Chain Monte Carlo (<a href="../2025/statistical_physics.html#markov-chain-monte-carlo">MCMC</a>) samples from the posterior distribution of potential values for the scores&nbsp;<span class="math inline">\(\boldsymbol{s}\)</span> and the depth&nbsp;<span class="math inline">\(\beta\)</span>,</p>
<div style="overflow-x:auto;overflow-y:hidden;">
<p><span class="math display">\[\begin{align}
    P(\boldsymbol{s}, \beta|\boldsymbol{A}) = \frac{P(\boldsymbol{A}|\boldsymbol{s})P(\boldsymbol{s}|\beta)P(\beta)}{P(\boldsymbol{A})}.
\end{align}\]</span></p>
</div>
<p>In <a href="#fig-BT-posteriors" class="quarto-xref">Figure&nbsp;4</a> the resulting posterior distributions of the depth for the football victories and football hosting data sets are plotted. For the pattern of victories, we can infer a depth of&nbsp;<span class="math inline">\(\hat{\beta}_{\text{MAP}} \approx 1.9\)</span> within the conference, indicating that there are roughly 2 levels of play between a random pair of teams. Particularly, the victories posterior clearly excludes the case&nbsp;<span class="math inline">\(\beta = 0\)</span>, indicating strong evidence for the hierarchy over the fair coin model. On the other hand, the pattern of hosting among the teams favors a depth of 0, indicating that hierarchical structure is not present and that the fair coin model is more appropriate.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div id="fig-BT-posteriors" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-BT-posteriors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../assets/images/notes/depth_of_hierarchies/BT-posteriors.svg" class="img-fluid figure-img" style="width:8.16855in">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-BT-posteriors-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Posterior distribution of the depth&nbsp;<span class="math inline">\(\beta\)</span> inferred by the general Bradley-Terry in the football victories and football hosting data sets. There is strong evidence of a hierarchical structure among the pattern of victories, while the pattern of hosting does not exclude the possibility that outcomes are fully random, highlighted at&nbsp;<span class="math inline">\(\beta = 0\)</span>.
</figcaption>
</figure>
</div>
<p>In <a href="https://www.science.org/doi/10.1126/sciadv.adn2654">our paper</a>, we discuss how this model can be further generalized to model a "luck" component of hierarchies where upsets are possible even between competitors of very different status. This generalization also includes the minimum violation ranking originally considered in this section, allowing for a direct comparison of the two ranking methods. In that chapter we also infer the depths of a variety of different data sets, ranging from sports and games to human and animal social hierarchies. <a href="#fig-depth-comparison" class="quarto-xref">Figure&nbsp;5</a> summarizes these results.</p>
<div id="fig-depth-comparison" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-depth-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../../assets/images/notes/depth_of_hierarchies/depth-comparison.svg" class="img-fluid figure-img" style="width:9.28353in">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-depth-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Depths of hierarchies inferred by our model across various applications. A depth of&nbsp;<span class="math inline">\(\beta = 0\)</span> corresponds to outcomes determined by fair coin flips while higher values of&nbsp;<span class="math inline">\(\beta\)</span> indicate deeper, stricter hierarchies. Full posterior distributions of&nbsp;<span class="math inline">\(\beta\)</span> for these cases are given in <a href="https://www.science.org/doi/10.1126/sciadv.adn2654">our paper</a>.
</figcaption>
</figure>
</div>
<p>The sports and games we consider in <a href="#fig-depth-comparison" class="quarto-xref">Figure&nbsp;5</a> – highlighted in red – vary in their depth yet tend to have a low&nbsp;<span class="math inline">\(\beta\)</span> compared to other contexts. Human social hierarchies (in green), such as patterns of friendships or of faculty hiring between universities, have a deeper, steeper hierarchy than these sports. And more than both these cases, we find that the animal social hierarchies (in blue) are very strict, with exceedingly large&nbsp;<span class="math inline">\(\beta\)</span> values in some cases. Although the model does not know the source of a given network, whether it represents sports matches, human or animal interactions, it consistently categories the examples by measuring the depth of each context. With this ability to measure properties like the inequality in a hierarchy in hand, we can start to speculate and investigate what factors lead to these contrasting effects. For example, sports leagues are designed to be competitive for entertainment value, whereas social hierarchies are subject to no such incentives. By considering all of these applications within a unified model we can draw comparisons between them.</p>
<p>By simply extending this near century-old model using Bayesian techniques, we have been able to both better understand positions within hierarchies and to measure the depth of these hierarchies: how those differences in rank translate to differences in behaviors and outcomes depending on the setting.</p>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-BT52" class="csl-entry" role="listitem">
Bradley, R. A., and M. E. Terry. 1952. <span>“Rank Analysis of Incomplete Block Designs: <span>I</span>. <span>T</span>he Method of Paired Comparisons.”</span> <em>Biometrika</em> 39: 324–45.
</div>
<div id="ref-CCP23" class="csl-entry" role="listitem">
Cavallaro, Claudia, Vincenzo Cutello, and Mario Pavone. 2023. <span>“Effective Heuristics for Finding Small Minimal Feedback Arc Set Even for Large Graphs.”</span> In <em>itaDATA</em>.
</div>
<div id="ref-Football22" class="csl-entry" role="listitem">
<span>“College Football Records.”</span> n.d. <span><a href="https://www.sports-reference.com/cfb/">URL</a></span>.
</div>
<div id="ref-JN24" class="csl-entry" role="listitem">
Jerdee, Maximilian, and M. E. J. Newman. 2024. <span>“Luck, Skill, and Depth of Competition in Games and Social Hierarchies.”</span> <em>Science Advances</em> 10 (45): eadn2654.
</div>
<div id="ref-Newman06b" class="csl-entry" role="listitem">
Newman, M. E. J. 2006. <span>“Modularity and Community Structure in Networks.”</span> <em>Pnas</em> 103: 8577–82.
</div>
<div id="ref-Zermelo29" class="csl-entry" role="listitem">
Zermelo, Ernst. 1929. <span>“Die <span>B</span>erechnung Der <span>T</span>urnier-<span>E</span>rgebnisse Als Ein <span>M</span>aximumproblem Der <span>W</span>ahrscheinlichkeitsrechnung.”</span> <em>Mathematische Zeitschrift</em> 29: 436–60.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Identifying hierarchy as the optimum of an objective is similar to how the modularity is often maximized to identify group structure <span class="citation" data-cites="Newman06b">(<a href="#ref-Newman06b" role="doc-biblioref">Newman 2006</a>)</span>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>We use a Half-cauchy prior <span class="math inline">\(P(\beta) = \frac{8}{\pi(\beta^2 + 16)}\)</span> of width 4, although the form of this single choice does not influence the overall results nearly as much as the prior over the scores which impacts each player individually.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>We can also support these conclusions through direct computations of the description length and predictive power of each model for each data set. (See Chapter 1.2.4 of my <a href="../2025/thesis.html">PhD thesis</a>)<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>